{% extends 'base.html' %}
{% block title %}Case List{% endblock %}

{% block addToHead %}
    <script src="https://use.fontawesome.com/d24120a7b5.js"></script>
{% endblock %}

{% block content %}
<h1>Case name: {{ case.case_name }}</h1>
<p><a href='/case-settings/{{ case.case_id}}'>Case settings</a></p>
<a href="/upload-video?case_id={{ case.case_id }}"><button>Upload a new video</button></a>
<input type="text" id="table-search" onkeyup="filterTable(5)" placeholder="Search...">
<table data-toggle="table" class="table table-sortable" id="clip-table">
    <thead>
        <tr>
            <th><input type='checkbox' id="select-all"></th>
            <th onclick="sortTable(1)">Deponent 
                <span class='glyphicon glyphicon-sort'></span></th>
            <th onclick="sortTable(2)">Date recorded 
                <span class='glyphicon glyphicon-sort'></span></th>
            <th onclick="sortTable(3)">Video name
                <span class='glyphicon glyphicon-sort'></span></th>
            <th onclick="sortTable(4)">Status
                <span class='glyphicon glyphicon-sort'></span></th>
            <th onclick="sortTable(5)" class='center-column'>Transcript?
                <span class='glyphicon glyphicon-sort'></span></th>
            <th class='center-column'>Trim new</th>
            <th class='center-column'>See existing</th>

        </tr>
    </thead>
    {% for video in videos %}
    <tbody>
        <tr>
            <!--case name-->
            <!--video comes in tuples (video[0] = vid_name, video[1] = vid_id, video[2] = vid_status)-->
            <td><input type='checkbox' class='vidcheck' value={{ video.vid_id }}></td>
            <td>{{ video.deponent }}</td>
            <td>{{ video.recorded_at }}</td>
            <td><a value='{{ video.vid_name }}' href = '/show-video/{{ video.vid_id }}' target='_blank'>{{ video.vid_name }}</a></td>
            <td>{{ video.vid_status }}</td>
            <td class='center-column'>
                {% if video.transcript %}
                    <i class="fa fa-file-text tscriptTrue" aria-hidden="true" id='{{ video.vid_id }}'></i>
                {% else %}
                    <i class="fa fa-file-text tscriptFalse" aria-hidden="true" id='{{ video.vid_id }}'></i>
                {% endif %}
            </td>
            <td class='center-column'><a href = '/trim-video/{{ video.vid_id }}'><i class="fa fa-scissors" aria-hidden="true"></i></a></td>
            <td class='center-column'><a href = '/clips/{{ video.vid_id }}'>
                <i class="fa fa-film" aria-hidden="true"></i> 
                <i class="fa fa-search" aria-hidden="true"></i></a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button type="button" id='downloadClips' value="Download">Download Videos</button>
<button type="button" id='deleteClips' value="Delete">Delete Videos</button>

<script src="/static/js/table_sort.js"></script>

<script>

function showScript(evt) {
    vid_id = evt.currentTarget.id;

    var params = 'scrollbars=yes,resizable=yes,status=no,location=no,toolbar=no,menubar=no,width=900,height=600,left=-1000,top=-1000';

    window.open('/show-transcript/'+vid_id, 'Transcript', params)
}

function addScript(evt) {
    vid_id = evt.currentTarget.id;

    var params = 'scrollbars=yes,resizable=yes,status=no,location=no,toolbar=no,menubar=no,width=900,height=600,left=-1000,top=-1000';

    window.open('/add-transcript/'+vid_id, 'Add Transcript', params)
}

$('.tscriptTrue').on('click', showScript)
$('.tscriptFalse').on('click', addScript)

function collect_checked_vids(evt){

    //get an array of all the checked clips
    var checked_vids = $('.vidcheck:checkbox:checked')
    var vidsToDL = [];
    for(var i = 0; i < checked_vids.length; i++){
        console.log(checked_vids[i].value)
        vidsToDL.push(checked_vids[i].value)
    }
    vids = vidsToDL.toString();
    console.log(vids)
    var formInputs = {
        'clips': vids,
        'call_func': evt.currentTarget.id,
        'vid_type': "video"
    }

    var all_cboxes = $('.vidcheck:checkbox')
    all_cboxes.prop('checked', false);

    if (evt.currentTarget.id == 'downloadClips') {
        console.log("download")
        //send direction to server
        //download function called from the handle-clips route
        $.post('/handle-clips', formInputs, function() {
        console.log('request complete')
        location.reload();
        });
    }
    else if (evt.currentTarget.id == 'deleteClips') {
        console.log("delete")
        var confirm_delete = confirm('Are you sure you want to delete '+checked_vids.length+' clips?\nThis action cannot be undone.');
        //send direction to server
        //delete function called from the handle-clips route
        if (confirm_delete == true)
            $.post('/handle-clips', formInputs, function() {
                console.log('request complete')
                location.reload();
            });
    }
}

function toggleChecks(evt) {
    var status = evt.currentTarget.checked
    console.log(status)
    var all_cboxes = $('.vidcheck:checkbox')
    if (status == true) {
        console.log("if")
        all_cboxes.prop('checked', true);
    }
    else {
        console.log("else")
        all_cboxes.prop('checked', false);
    }

}

$('#downloadClips').on('click', collect_checked_vids)
$('#deleteClips').on('click', collect_checked_vids)
$('#select-all').on('change', toggleChecks)


</script>
{% endblock %}