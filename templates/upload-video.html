

<!-- <form action="http://videotrim.s3.amazonaws.com/" method="post" 
enctype="multipart/form-data"> -->
{% extends 'base.html' %}
{% block title %}Select a video to upload{% endblock %}

{% block addToHead %}
<!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/dropzone.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/dropzone.js"></script>  
<script type="text/javascript" src="js/bootstrap-fileprogress.js"> </script> -->
{% endblock %}

{% block content %}
<form action="#" enctype="multipart/form-data" method="POST" id='vid-upload'>
    <input type="text" name="name" id="name" placeholder="Jane Doe"><br/>
    <input type="date" name="date-taken" id="date-taken"><br/>
    Video file:<input type="file" name='rawvid' id='rawvid' required><br/>
    Text Transcript:<input type="file" name='tscript' id='tscript'></br>
    <input type="hidden" name='case_id' id='case_id' value={{ case_id }}>
    <input type="submit" value='Upload'>
</form>

<form id="upload_form" enctype="multipart/form-data" method="POST">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <input type="file" name="fileUploader" id="fileUploader" class="btn btn-default" multiple>
                </div>
                <div class="col-md-4" style="text-align:right;">
                    <input type="button" id="btnUpload" style="display:none" class="btn btn-default" value="Upload File" onclickâ€‹="uploadFiles()">
                </div>
            </div>
            <div class="row">
                <div id="divFiles" class="files">
                </div>
            </div>
        </div>
    </form>

<!-- <div class="progress">
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;">
    0%
  </div>
</div> -->

<script>
    function upload_video(evt) {
        var progress = parseInt(evt.loaded / evt.total * 100)
        console.log(progress)
        var formData = {
            'name': $('#name').val(),
            'date-taken': $('#date-taken').val(),
            'rawvid': $('#rawvid').val(),
            'case_id': $('#case_id').val()
            'tscript': $('#tscript').val()
        };
        $.post('/upload-video', formData).then(function (results) {
            console.log(results);
        })
    }

    $('#vid-upload').on('submit', upload_video);
</script>

<script>
$(document).ready(function () {
   $('input[type=file]').change(function () {
     $('#btnUpload').show();
     $('#divFiles').html('');
     for (var i = 0; i < this.files.length; i++) { //Progress bar and status label's for each file genarate dynamically
          var fileId = i;
          $("#divFiles").append('<div class="col-md-12">' +
                  '<div class="progress-bar progress-bar-striped active" id="progressbar_' + fileId + '" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>' +
                  '</div>' +
                  '<div class="col-md-12">' +
                       '<div class="col-md-6">' +
                          '<input type="button" class="btn btn-danger" style="display:none;line-height:6px;height:25px" id="cancel_' + fileId + '" value="cancel">' +
                       '</div>' +
                       '<div class="col-md-6">' +
                          '<p class="progress-status" style="text-align: right;margin-right:-15px;font-weight:bold;color:saddlebrown" id="status_' + fileId + '"></p>' +
                       '</div>' +
                  '</div>' +
                  '<div class="col-md-12">' +
                       '<p id="notify_' + fileId + '" style="text-align: right;"></p>' +
                  '</div>');
                }
            })
        });
     console.log("Added")

function uploadFiles() {
    console.log('click')
   var file = document.getElementById("fileUploader")//All files
   for (var i = 0; i < file.files.length; i++) {
          uploadSingleFile(file.files[i], i);
   }
}

function uploadSingleFile(file, i) {
            var fileId = i;
            var ajax = new XMLHttpRequest();
            console.log("file")
            //Progress Listener
            ajax.upload.addEventListener("progress", function (e) {
                var percent = (e.loaded / e.total) * 100;
                $("#status_" + fileId).text(Math.round(percent) + "% uploaded, please wait...");
                $('#progressbar_' + fileId).css("width", percent + "%")
                $("#notify_" + fileId).text("Uploaded " + (e.loaded / 1048576).toFixed(2) + " MB of " + (e.total / 1048576).toFixed(2) + " MB ");
            }, false);
            //Load Listener
            ajax.addEventListener("load", function (e) {
                $("#status_" + fileId).text(event.target.responseText);
                $('#progressbar_' + fileId).css("width", "100%")

                //Hide cancel button
                var _cancel = $('#cancel_' + fileId);
                _cancel.hide();
            }, false);
            //Error Listener
            ajax.addEventListener("error", function (e) {
                $("#status_" + fileId).text("Upload Failed");
            }, false);
            //Abort Listener
            ajax.addEventListener("abort", function (e) {
                $("#status_" + fileId).text("Upload Aborted");
            }, false);

            ajax.open("POST", "/upload-video"); // Your API .net, php

            var uploaderForm = new FormData(); // Create new FormData
            uploaderForm.append("file", file); // append the next file for upload
            ajax.send(uploaderForm);

            //Cancel button
            var _cancel = $('#cancel_' + fileId);
            _cancel.show();

            _cancel.on('click', function () {
                ajax.abort();
            })
        }
</script>
{% endblock %}